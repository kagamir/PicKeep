# PicKeep - 零知识加密照片备份

PicKeep 是一个 Android 应用，提供零知识加密的照片备份服务。所有照片在本地进行端到端加密，服务器无法读取您的照片内容。

## 核心特性

### 零知识加密
- **端到端加密**：照片和元数据在上传前进行 AES-256-GCM 加密
- **BIP39 助记词**：使用 12 词助记词生成主密钥，支持多设备恢复
- **密钥派生**：使用 PBKDF2-HMAC-SHA256（100,000 次迭代）从用户密码派生密钥加密密钥（KEK）
- **独立密钥**：每个文件使用独立的内容加密密钥（CEK），用主密钥加密后存储
- **隐私保护**：远程文件名基于文件内容的 HMAC-SHA256，不泄露任何元数据

### 增量同步
- **智能检测**：通过 MediaStore 监控照片和视频变化，检测修改时间和大小
- **分片上传**：大文件（>10MB）和视频自动使用 5MB 分片上传
- **动态并发**：根据可用内存自动调整并发数（1-3 个并发任务）
- **批量处理**：分批处理待上传文件，每批最多 10 个文件
- **智能重试**：指数退避重试机制（最多 5 次），HTTP 4xx 错误不重试
- **状态管理**：完整的同步状态追踪，包括哈希计算、加密、上传等步骤
- **进度显示**：实时显示每个文件的上传进度和当前步骤

### WebDAV 支持
- **标准协议**：兼容 Nextcloud、ownCloud 等 WebDAV 服务
- **TLS 加密**：传输层使用 HTTPS 保护
- **灵活配置**：支持自定义服务器地址和认证

### 后台任务
- **WorkManager**：使用 Android WorkManager 进行后台同步
- **智能调度**：可配置同步间隔（1-24 小时）、网络条件（仅 WiFi）、充电状态
- **前台服务**：同步时显示进度通知，包含当前上传文件和步骤信息
- **应用锁定**：应用进入后台 5 分钟后自动锁定，主密钥从内存清除

## 技术架构

### 依赖库
- **Jetpack Compose**：现代化的声明式 UI
- **Room**：本地数据库，存储照片元数据和同步状态
- **WorkManager**：后台任务调度
- **OkHttp**：HTTP 客户端，实现 WebDAV 协议
- **Kotlinx Serialization**：JSON 序列化
- **EncryptedSharedPreferences**：安全存储敏感配置（WebDAV 凭据等）
- **Bouncy Castle**：加密库支持（AES-GCM）
- **AndroidX ExifInterface**：读取照片元数据（地理位置等）

### 项目结构
```
app/src/main/java/net/kagamir/pickeep/
├── crypto/                  # 加密层
│   ├── Bip39.kt            # BIP39 助记词实现
│   ├── KeyDerivation.kt    # 密钥派生（PBKDF2）
│   ├── CekManager.kt       # CEK 管理（生成、加密、解密）
│   ├── FileEncryptor.kt    # 文件加密（AES-256-GCM）
│   ├── MetadataEncryptor.kt # 元数据加密
│   ├── PhotoMetadata.kt    # 照片元数据模型
│   └── MasterKeyStore.kt   # 主密钥管理（锁定、解锁、密码修改）
├── data/
│   ├── local/              # 本地数据
│   │   ├── entity/        # 数据实体
│   │   ├── dao/           # 数据访问对象
│   │   └── PicKeepDatabase.kt
│   └── repository/         # 数据仓库
├── storage/                # 存储层
│   ├── StorageClient.kt    # 存储客户端接口
│   ├── RemoteFileInfo.kt   # 远程文件信息
│   └── webdav/            # WebDAV 实现
│       ├── WebDavClient.kt # WebDAV 客户端
│       └── ChunkedUploader.kt # 分片上传器
├── monitor/                # 监控层
│   ├── MediaStoreObserver.kt
│   ├── FileSystemObserver.kt
│   └── PhotoScanner.kt     # 照片扫描器（MediaStore 查询）
├── sync/                   # 同步引擎
│   ├── SyncEngine.kt       # 同步引擎（批量上传、并发控制）
│   ├── UploadTask.kt       # 上传任务（单文件上传流程）
│   └── SyncState.kt        # 同步状态管理（单例）
├── worker/                 # 后台任务
│   ├── PhotoSyncWorker.kt
│   └── WorkManagerScheduler.kt
└── ui/                     # UI 层
    ├── screen/            # 界面
    │   ├── SetupScreen.kt      # 初始化界面（创建/恢复账户）
    │   ├── UnlockScreen.kt     # 解锁界面
    │   ├── SyncStatusScreen.kt # 同步状态界面（主界面）
    │   └── SettingsScreen.kt   # 设置界面
    ├── navigation/        # 导航
    │   └── NavGraph.kt    # 导航图
    └── theme/             # 主题
        ├── Color.kt       # 颜色定义
        ├── Theme.kt       # Material3 主题
        └── Type.kt        # 字体样式
```

## 安全设计

### 加密方案
1. **主密钥（Master Key）**
   - 从 BIP39 助记词（12 词）派生，使用 BIP39 标准（PBKDF2WithHmacSHA512，2048 次迭代）
   - 取种子（seed）的前 256 位作为主密钥
   - 仅存储在内存中，应用锁定时清除
   - 支持导出助记词用于多设备恢复

2. **密钥加密密钥（KEK）**
   - 从用户密码通过 PBKDF2-HMAC-SHA256 派生（100,000 次迭代）
   - 用于加密包装主密钥，存储在 EncryptedSharedPreferences 中
   - 修改密码时重新包装主密钥，无需重新加密文件

3. **内容加密密钥（CEK）**
   - 每个文件独立生成 256-bit 随机密钥
   - 用主密钥加密后存储在本地数据库（Room）
   - 支持密钥轮换和撤销

4. **文件加密**
   - 算法：AES-256-GCM
   - 模式：流式加密（64KB 分块）
   - IV：每个文件使用随机 12 字节 IV
   - 认证：包含 16 字节认证标签，防止篡改
   - 格式：`[版本号(1字节)][IV(12字节)][密文...][标签(16字节)]`

5. **元数据加密**
   - 原始文件名、时间戳、地理位置、MIME 类型等信息全部加密
   - 使用与文件相同的 CEK 加密
   - 单独上传到 `.meta` 文件，服务器无法索引或搜索

### 隐私保护
- 远程文件名基于文件内容的 HMAC-SHA256（使用主密钥派生的盐），不泄露任何信息
- 不上传明文哈希，防止服务器识别文件内容
- 每个设备独立的设备 ID（UUID），但不关联用户身份
- 元数据完全加密，包括 EXIF 地理位置信息

## 使用指南

### 初始设置
1. **首次启动**：应用会引导您完成初始化流程
2. **创建账户**：
   - 设置密码（至少 12 位，包含大小写字母和数字）
   - 系统会生成 12 词 BIP39 助记词
   - **重要**：请妥善保存助记词，建议离线记录（纸质或密码管理器）
3. **恢复账户**：如果已有助记词，可以选择"使用助记词恢复"
4. **授予权限**：授予照片和媒体访问权限

### 配置 WebDAV
1. 进入设置界面
2. 输入 WebDAV 服务器地址（例如：`https://cloud.example.com/remote.php/webdav`）
3. 输入用户名和密码
4. 点击"测试连接"验证配置
5. 保存设置

### 同步设置
- **自动同步**：启用后定期自动备份
- **同步间隔**：1-24 小时可选（默认 12 小时）
- **WiFi 限制**：仅在 WiFi 下同步，节省流量（默认启用）
- **充电限制**：仅在充电时同步，节省电量（默认关闭）
- **监控格式**：可配置监控的文件后缀（默认：jpg, jpeg, png, gif, webp, heic, heif, mp4, mkv, avi, mov, 3gp）

### 手动同步
点击主界面的同步按钮立即开始同步。同步过程中可以：
- 查看实时进度和当前上传的文件
- 暂停/继续同步
- 取消同步

### 上传流程
每个文件的上传包含以下步骤：
1. **计算哈希**：计算文件的 SHA-256 哈希值
2. **加密文件**：使用 AES-256-GCM 加密文件
3. **生成路径**：基于文件内容生成远程路径
4. **上传文件**：上传加密文件（大文件自动分片）
5. **上传元数据**：上传加密的元数据文件

## 恢复与多设备

### 导出助记词
1. 在设置中选择"导出助记词"（需要先解锁应用）
2. 妥善保存 12 词助记词（建议离线保存，如纸质或密码管理器）
3. **警告**：丢失助记词和密码将无法恢复数据

### 在新设备上恢复
1. 安装应用后选择"使用助记词恢复"
2. 输入 12 词助记词和原密码
3. 配置相同的 WebDAV 服务器
4. 应用将同步所有加密照片和元数据

### 修改密码
1. 在设置中选择"修改密码"
2. 输入旧密码和新密码
3. 系统会重新包装主密钥，无需重新加密文件

## 限制与注意事项

### 当前版本限制
- WebDAV 分片上传需要服务器支持 PUT 方法的分片上传
- 大文件（>100MB）和视频可能需要较长时间，建议在 WiFi 和充电状态下同步
- 冲突解决采用简化策略（保留所有版本，使用设备 ID 区分）
- 应用进入后台 5 分钟后自动锁定，需要重新输入密码解锁

### 安全建议
- 使用强密码（推荐密码管理器生成，至少 12 位）
- **必须**妥善保存助记词（离线保存，如纸质或密码管理器）
- 使用可信的 WebDAV 服务器（建议自建 Nextcloud/ownCloud）
- 启用 WebDAV 服务器的 TLS 加密（HTTPS）
- 定期检查同步状态，确保重要照片已备份

### 性能建议
- 首次同步建议在 WiFi 和充电状态下进行
- 大量照片（>1000 张）可能需要数小时，请耐心等待
- 应用会根据可用内存自动调整并发数，无需手动配置
- 定期清理失败的同步记录（可在设置中重置上传历史）

### 支持的媒体格式
- **图片**：JPG, JPEG, PNG, GIF, WEBP, HEIC, HEIF
- **视频**：MP4, MKV, AVI, MOV, 3GP
- 可在设置中自定义监控的文件后缀

## 开发与贡献

### 构建要求
- Android Studio Hedgehog (2023.1.1) 或更高
- JDK 11 或更高
- Android SDK 36（compileSdk）
- 最低支持 Android 12 (API 31)
- Target SDK 33

### 构建步骤
```bash
git clone <repository-url>
cd PicKeep
./gradlew assembleDebug
```

### 技术债务（未来改进）
- [ ] 支持更多云存储协议（S3、自定义 API）
- [ ] 改进冲突解决 UI 和策略
- [ ] 支持照片选择性同步（白名单/黑名单）
- [ ] 添加端到端加密的照片查看器
- [ ] 实现 Argon2id 密钥派生（性能优化，替代 PBKDF2）
- [ ] 支持更多 BIP39 助记词长度（24 词）
- [ ] 实现真正的断点续传（保存上传进度）
- [ ] 支持照片删除同步
- [ ] 添加同步历史记录
- [ ] 支持多账户切换

## 许可证
GNU GENERAL PUBLIC LICENSE VERSION 3

## 免责声明

本应用处于技术验证阶段，仅用于演示零知识加密的照片备份方案。生产环境使用前需要：
1. 完整的安全审计
2. 更完善的错误处理
3. 数据库迁移策略
4. 完整的单元测试和集成测试
5. 性能优化和压力测试

请勿将重要数据完全依赖于本应用，建议保留本地备份。

